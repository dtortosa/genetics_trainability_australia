
#######################################
#######################################
checking function to print nicely: header 1
#######################################
#######################################

###### checking function to print nicely: header 2 ######

## checking function to print nicely: header 3 ##

# checking function to print nicely: header 4 #

#######################################
#######################################
check behaviour run_bash
#######################################
#######################################

###### see working directory ######
/home/dftortosa/diego_docs/science/other_projects/australian_army_bishop/heavy_analyses/australian_army_bishop/association_studies


###### list files/folders there ######
03a_association_analyses.sif
03a_phenotype_prep.out
03aa_final_pca_calc.out
data
ldak6.1.linux
literature
results
scripts

total 677908
-rwxr-xr-x 1 dftortosa dftortosa 671535104 Apr  2 19:14 03a_association_analyses.sif
-rw-rw-r-- 1 dftortosa dftortosa     73112 Feb 14 07:16 03a_phenotype_prep.out
-rw-rw-r-- 1 dftortosa dftortosa         0 Apr  3 11:50 03aa_final_pca_calc.out
drwxr-xr-x 6 dftortosa dftortosa      4096 Apr  3 11:50 data
-rwxrwxr-x 1 dftortosa dftortosa  22546352 Jan 27 19:43 ldak6.1.linux
drwxr-xr-x 3 dftortosa dftortosa      4096 Oct 31  2023 literature
drwxr-xr-x 4 dftortosa dftortosa      4096 Jan 24 17:57 results
drwxr-xr-x 4 dftortosa dftortosa      4096 Oct 31  2023 scripts


#######################################
#######################################
SELECT ONLY GENOTYPES VARIANTS
#######################################
#######################################

###### create folders ######


###### define function to extract the genotypes SNPs across chromosomes ######

###### run function in parallel across chromosomes ######

## set chromosomes ##
['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22']

## parallelize ##

Lines   total/split/realigned/skipped:	3501/0/0/0



Lines   total/split/realigned/skipped:	3653/0/0/0



Lines   total/split/realigned/skipped:	6199/0/0/0



Lines   total/split/realigned/skipped:	5375/0/0/0



Lines   total/split/realigned/skipped:	7599/0/0/0



Lines   total/split/realigned/skipped:	7257/0/0/0



Lines   total/split/realigned/skipped:	8102/0/0/0



Lines   total/split/realigned/skipped:	7176/0/0/0



Lines   total/split/realigned/skipped:	8067/0/0/0



Lines   total/split/realigned/skipped:	9094/0/0/0



Lines   total/split/realigned/skipped:	12111/0/0/0



Lines   total/split/realigned/skipped:	11859/0/0/0



Lines   total/split/realigned/skipped:	10719/0/0/0



Lines   total/split/realigned/skipped:	12416/0/0/0



Lines   total/split/realigned/skipped:	12534/0/0/0



Lines   total/split/realigned/skipped:	13608/0/0/0



Lines   total/split/realigned/skipped:	14267/0/0/0



Lines   total/split/realigned/skipped:	18244/0/0/0



Lines   total/split/realigned/skipped:	15052/0/0/0



Lines   total/split/realigned/skipped:	16798/0/0/0



Lines   total/split/realigned/skipped:	19170/0/0/0



Lines   total/split/realigned/skipped:	19897/0/0/0



###### merge all chromosomes ######

## get a sorted list of all .tsv files in the folder with natural sorting (i.e., 1,2,3... ##
['chr1_snp_list.tsv', 'chr2_snp_list.tsv', 'chr3_snp_list.tsv', 'chr4_snp_list.tsv', 'chr5_snp_list.tsv', 'chr6_snp_list.tsv', 'chr7_snp_list.tsv', 'chr8_snp_list.tsv', 'chr9_snp_list.tsv', 'chr10_snp_list.tsv', 'chr11_snp_list.tsv', 'chr12_snp_list.tsv', 'chr13_snp_list.tsv', 'chr14_snp_list.tsv', 'chr15_snp_list.tsv', 'chr16_snp_list.tsv', 'chr17_snp_list.tsv', 'chr18_snp_list.tsv', 'chr19_snp_list.tsv', 'chr20_snp_list.tsv', 'chr21_snp_list.tsv', 'chr22_snp_list.tsv']

## sequentially merge the .tsv files ##

## save the full DF and also just the IDs column ##

## check we have all the SNPs ##
242698


###### prepare plink fileset ######

## check we have the correct versions of plink and plink2. We are using plink1.9 for mergning ##
PLINK v1.90b7 64-bit (16 Jan 2023)

PLINK v2.00a4.2LM 64-bit Intel (31 May 2023)

PLINK VERSIONS ARE OK

## subset the plink filesets ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./data/final_pcas/00_typed_variants_after_qc/merged_3_geno_only_typed.log.
Options in effect:
  --bfile ../quality_control/data/genetic_data/quality_control/21_post_imputation_qc/03_third_qc_step/merged_3_geno
  --extract ./data/final_pcas/00_typed_variants_after_qc/merged_snps_list_id_only.txt
  --make-bed
  --out ./data/final_pcas/00_typed_variants_after_qc/merged_3_geno_only_typed

63997 MB RAM detected; reserving 31998 MB for main workspace.
3197605 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
--extract: 242613 variants remaining.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
242613 variants and 1203 people pass filters and QC.
Note: No phenotypes present.
--make-bed to
./data/final_pcas/00_typed_variants_after_qc/merged_3_geno_only_typed.bed +
./data/final_pcas/00_typed_variants_after_qc/merged_3_geno_only_typed.bim +
./data/final_pcas/00_typed_variants_after_qc/merged_3_geno_only_typed.fam ...
0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.


## check we have the correct number of SNPs ##


## check we have the correct number of samples ##


## check we do NOT have a .missnp file ##
FILTERING WORKED


## see the total number of SNPs ##
242613


#######################################
#######################################
DO LD CLEANING OF VARIANTS
#######################################
#######################################

###### create folders ######


###### Filter out snps with high LD ######

## get a list of SNPs with low LD ##
PLINK v2.00a4.2LM 64-bit Intel (31 May 2023)   www.cog-genomics.org/plink/2.0/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./01_ld_cleaning/ld_prunning_filter.log.
Options in effect:
  --bfile ./00_typed_variants_after_qc/merged_3_geno_only_typed
  --indep-pairwise 600kb 1 0.1
  --out ./01_ld_cleaning/ld_prunning_filter

Start time: Thu Apr  3 12:00:31 2025
63997 MiB RAM detected, ~56522 available; reserving 31998 MiB for main
workspace.
Using up to 32 threads (change this with --threads).
1203 samples (168 females, 1035 males; 1203 founders) loaded from
./00_typed_variants_after_qc/merged_3_geno_only_typed.fam.
242613 variants loaded from
./00_typed_variants_after_qc/merged_3_geno_only_typed.bim.
Note: No phenotype data present.
Calculating allele frequencies... 0%27%54%81%done.
--indep-pairwise (22 compute threads): 0%50%189624/242613 variants removed.
Writing...
Variant lists written to ./01_ld_cleaning/ld_prunning_filter.prune.in and
./01_ld_cleaning/ld_prunning_filter.prune.out .
End time: Thu Apr  3 12:00:31 2025
total 4424
-rw-rw-r-- 1 dftortosa dftortosa    1127 Apr  3 12:00 ld_prunning_filter.log
-rw-rw-r-- 1 dftortosa dftortosa  988320 Apr  3 12:00 ld_prunning_filter.prune.in
-rw-rw-r-- 1 dftortosa dftortosa 3533836 Apr  3 12:00 ld_prunning_filter.prune.out


## select only SNPs with low LD ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./01_ld_cleaning/merged_3_geno_only_typed_ld_prunning.log.
Options in effect:
  --bfile ./00_typed_variants_after_qc/merged_3_geno_only_typed
  --extract ./01_ld_cleaning/ld_prunning_filter.prune.in
  --make-bed
  --out ./01_ld_cleaning/merged_3_geno_only_typed_ld_prunning

63997 MB RAM detected; reserving 31998 MB for main workspace.
242613 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
--extract: 52989 variants remaining.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
52989 variants and 1203 people pass filters and QC.
Note: No phenotypes present.
--make-bed to ./01_ld_cleaning/merged_3_geno_only_typed_ld_prunning.bed +
./01_ld_cleaning/merged_3_geno_only_typed_ld_prunning.bim +
./01_ld_cleaning/merged_3_geno_only_typed_ld_prunning.fam ... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.
total 21932
-rw-rw-r-- 1 dftortosa dftortosa     1127 Apr  3 12:00 ld_prunning_filter.log
-rw-rw-r-- 1 dftortosa dftortosa   988320 Apr  3 12:00 ld_prunning_filter.prune.in
-rw-rw-r-- 1 dftortosa dftortosa  3533836 Apr  3 12:00 ld_prunning_filter.prune.out
-rw-rw-r-- 1 dftortosa dftortosa 15949692 Apr  3 12:00 merged_3_geno_only_typed_ld_prunning.bed
-rw-rw-r-- 1 dftortosa dftortosa  1923651 Apr  3 12:00 merged_3_geno_only_typed_ld_prunning.bim
-rw-rw-r-- 1 dftortosa dftortosa    46917 Apr  3 12:00 merged_3_geno_only_typed_ld_prunning.fam
-rw-rw-r-- 1 dftortosa dftortosa     1240 Apr  3 12:00 merged_3_geno_only_typed_ld_prunning.log


## checks after filtering ##
The number of included autosomal SNPs in linkage equilibrium is 52989
Is this number greater than 52K?
TRUE


## We are not removing SNPs by high-LD regions ##

The high-LD regions indicated by Dr.Speed are in hg19 coordinates, while we are working with hg38. I tried liftovering the regions, but I was not able to do it and got extrange results like getting hg38 coordinates in the X chromosome when we do not have sex chromosomes.

Given that just incresing the prunning to 600kb and 0.1 made the SNP weigths peak completely dissapear. Importantly, if you compare the PCA plots between this subset and the PCA during QC, you can see they are really similar, it seems we are still detecting the same variability. So I think we are good.
      
This is what we have anyways. If we want to have SNPs with very low-LD, no peaks in the PCA loadings and, in general, the clean dataset, this is what is left after QC.


#######################################
#######################################
RUN SMART PCA
#######################################
#######################################

## create folders ##


## PCA with smartpca ##

## prepare fam file for smartpca ##


## decide the number of axes to output ##

## smartpca parameter file ##


## run smartpca ##


## check the number of samples after outlier removal ##


## see significant axes ##


# load the table #
        #N  eigenvalue  difference   twstat       p-value    effect.
0        1    1.677892         NaN  179.068  0.000000e+00  44114.234
1        2    1.427363   -0.250528   41.135  2.297970e-78  44616.721
2        3    1.357132   -0.070232    2.335  5.836760e-03  44764.372
3        4    1.355044   -0.002088    1.663  1.803420e-02  44842.037
4        5    1.351356   -0.003687    0.081  1.538060e-01  44918.799
...    ...         ...         ...      ...           ...        ...
1197  1198    0.709644   -0.002193      NaN           NaN        NaN
1198  1199    0.709331   -0.000313      NaN           NaN        NaN
1199  1200    0.708184   -0.001147      NaN           NaN        NaN
1200  1201    0.706919   -0.001265      NaN           NaN        NaN
1201  1202    0.698934   -0.007985      NaN           NaN        NaN

[1202 rows x 6 columns]

# print significant axes #
   #N  eigenvalue  difference   twstat       p-value    effect.
0   1    1.677892         NaN  179.068  0.000000e+00  44114.234
1   2    1.427363   -0.250528   41.135  2.297970e-78  44616.721
2   3    1.357132   -0.070232    2.335  5.836760e-03  44764.372
3   4    1.355044   -0.002088    1.663  1.803420e-02  44842.037

Results:
We have 4 significant axes, meaining that they explain more genetic variance than expected by chance.


## plot smartpca eigenvectors ##

# process the eigenvector file to ensure is tab delimited #

                                 0       1       2   ...      18      19      20
0     combat_ILGSA24-17303:0200ADMM  0.0017  0.0186  ...  0.0406  0.0211  0.0209
1     combat_ILGSA24-17303:0200ASJM  0.0792  0.0531  ... -0.0475 -0.0177  0.0044
2     combat_ILGSA24-17303:0200BHNM -0.0238  0.0139  ...  0.0226  0.0357 -0.0054
3     combat_ILGSA24-17303:0200CBOM -0.0173 -0.0008  ... -0.0248  0.0373  0.0693
4     combat_ILGSA24-17303:0200CDFM  0.0162 -0.0307  ... -0.0414  0.0096 -0.0182
...                             ...     ...     ...  ...     ...     ...     ...
1198  combat_ILGSA24-17873:9693JMNM -0.0060  0.0373  ... -0.0498 -0.0076  0.0175
1199  combat_ILGSA24-17873:9696DWFM -0.0107 -0.0055  ...  0.0167 -0.0049 -0.0371
1200  combat_ILGSA24-17873:9697STJM -0.0129  0.0044  ... -0.0050 -0.0028 -0.0166
1201  combat_ILGSA24-17873:9699DNOM  0.0442 -0.0465  ...  0.0240  0.0006 -0.0004
1202  combat_ILGSA24-17873:9699ISMM -0.0058 -0.0174  ... -0.0046 -0.0082 -0.0296

[1203 rows x 21 columns]

## plot the explained variance using eigenvalues ##

# load the eigenvalues #
             0
0     1.677892
1     1.427363
2     1.357132
3     1.355044
4     1.351356
...        ...
1198  0.709331
1199  0.708184
1200  0.706919
1201  0.698934
1202  0.000000

[1203 rows x 1 columns]

# check eigenvalues are in decreasing order #

# The proportion of total variance explained by each PC is a useful metric for understanding structure in a sample and for evaluating how many PCs one might want to include in downstream analyses (see Fig. 9). This can be computed as λi∕∑kλk, with λi being eigenvalues in decreasing order #

# change column names #
      eigenvalue  prop_variance
0       1.677892       0.001396
1       1.427363       0.001187
2       1.357132       0.001129
3       1.355044       0.001127
4       1.351356       0.001124
...          ...            ...
1198    0.709331       0.000590
1199    0.708184       0.000589
1200    0.706919       0.000588
1201    0.698934       0.000581
1202    0.000000       0.000000

[1203 rows x 2 columns]

# select the eigenvalues of the relevant axes #
    eigenvalue  prop_variance
0     1.677892       0.001396
1     1.427363       0.001187
2     1.357132       0.001129
3     1.355044       0.001127
4     1.351356       0.001124
5     1.346761       0.001120
6     1.345003       0.001119
7     1.342646       0.001117
8     1.340938       0.001116
9     1.338320       0.001113
10    1.336184       0.001112
11    1.334665       0.001110
12    1.333735       0.001110
13    1.332266       0.001108
14    1.330352       0.001107
15    1.329672       0.001106
16    1.328574       0.001105
17    1.327636       0.001105
18    1.326856       0.001104
19    1.325864       0.001103

# add a new column with the index (row numbers) and plot index vs the first and only column (eigenvalues) #

## plot SNP weights ##

# process the file to ensure it is tab delimited #


# load the file #

# sort the DF by chromosome and position #

# change column names #
                rs_number  chr       pos  pca_1  ...  pca_17  pca_18  pca_19  pca_20
0         chr1_858952_G_A    1    858952 -0.661  ...  -0.075  -0.281  -0.863  -0.764
1         chr1_905373_T_C    1    905373  0.942  ...   0.509   1.749   0.498   1.886
2         chr1_967941_G_A    1    967941 -0.728  ...  -0.032  -0.529  -1.708   1.176
3         chr1_983193_A_G    1    983193 -1.139  ...   0.488  -0.517  -0.182   0.331
4        chr1_1024129_T_G    1   1024129  0.446  ...   0.064  -0.177   0.012   0.020
...                   ...  ...       ...    ...  ...     ...     ...     ...     ...
52984  chr22_50701888_C_T   22  50701888 -1.236  ...   1.264   0.841   0.293   0.226
52985  chr22_50718505_A_G   22  50718505 -0.672  ...   1.684  -0.684  -0.400   0.516
52986  chr22_50743331_A_G   22  50743331  1.213  ...  -0.602   0.972   0.041   0.214
52987  chr22_50747848_T_C   22  50747848  1.700  ...   0.552   0.474  -0.506   1.281
52988  chr22_50749012_A_G   22  50749012  0.154  ...  -1.302  -0.180  -0.898  -0.082

[52989 rows x 23 columns]

# melt the DataFrame to have one row for each combination of chromosome and PCA axis #
                  rs_number  chr       pos pca_axis  snp_weight
0           chr1_858952_G_A    1    858952    pca_1      -0.661
1           chr1_905373_T_C    1    905373    pca_1       0.942
2           chr1_967941_G_A    1    967941    pca_1      -0.728
3           chr1_983193_A_G    1    983193    pca_1      -1.139
4          chr1_1024129_T_G    1   1024129    pca_1       0.446
...                     ...  ...       ...      ...         ...
1059775  chr22_50701888_C_T   22  50701888   pca_20       0.226
1059776  chr22_50718505_A_G   22  50718505   pca_20       0.516
1059777  chr22_50743331_A_G   22  50743331   pca_20       0.214
1059778  chr22_50747848_T_C   22  50747848   pca_20       1.281
1059779  chr22_50749012_A_G   22  50749012   pca_20      -0.082

[1059780 rows x 5 columns]

# check we have all the rows #

# get unique PCA axes and chromosomes #

# create subplots #

# make the plots #

#######################################
#######################################
FINAL CONCLUSIONS
#######################################
#######################################

#######################################
#######################################
FINISH
#######################################
#######################################
