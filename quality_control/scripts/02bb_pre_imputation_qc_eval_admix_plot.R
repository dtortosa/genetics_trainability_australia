#!/usr/bin/env Rscript

#we use the shebang "#!/usr/bin/env Rscript" to facilitate portability between machines. "env" offers more portability because it searches for the first occurrence of the R interpreter in the environment where we are running. It should thus look for R version installed in the container # nolint
    #https://www.r-bloggers.com/2019/11/r-scripts-as-command-line-tools/ # nolint
    #https://www.baeldung.com/linux/bash-shebang-lines

#This is done to have the possibility to run this script as an executable: 'chmod +x myscript.R' and then ' ./myscript.R'. If you run the script as 'R CMD BATCH myscript.R', i THINK this is not used, because it is annotated. # nolint
    #https://www.jonzelner.net/statistics/make/docker/reproducibility/2016/05/31/script-is-a-program/ # nolint

#In case you run this script as an executable, you can save the output without warnings "./myscript.R > myscript.Rout" or with errors "./myscript.R &> myscript.Rout" # nolint
    #https://askubuntu.com/questions/420981/how-do-i-save-terminal-output-to-a-file # nolint



###########################
##### BEGIN SCRIPT ########
###########################

#script based on:
    #http://popgen.dk/software/index.php/EvalAdmix#Run_command_example # nolint

#load the R script with the required functions
source("/opt/scripts/02ba_pre_imputation_qc_eval_admix_plot.R")
    #the source script for the functions was obtained from the evalAdmix: # nolint
        #https://github.com/GenisGE/evalAdmix/blob/master/visFuns.R # nolint

#load the FAM file used as input in Admixture
pop<-read.table("./data/genetic_data/quality_control/14_pop_strat/01_pca/loop_maf_missing_2_ldprunned_autosome_pca_not_outliers.fam") # nolint

#modify the batch column to reduce the size of the names
pop[pop[, 1] == "combat_ILGSA24-17303", 1] <- "batch_1"
pop[pop[, 1] == "combat_ILGSA24-17873", 1] <- "batch_2"

#load the Q file generated by Admixture
q<-read.table("./data/genetic_data/quality_control/14_pop_strat/02_admixture/admixture_cv/loop_maf_missing_2_ldprunned_autosome_pca_not_outliers.K1.Q", stringsAsFactors=T) # nolint

#load the correlation file generated by evalAdmix
r<-as.matrix(read.table("./data/genetic_data/quality_control/14_pop_strat/02_admixture/eval_admix/evaladmixOut.K1.corres")) # nolint

#set the color pallete
palette(c("#A6CEE3","#1F78B4","#B2DF8A","#33A02C","#FB9A99","#E31A1C","#FDBF6F","#FF7F00","#CAB2D6","#6A3D9A","#FFFF99","#B15928","#1B9E77","#999999")) # nolint

# order according to population (batch in our case)
ord <- orderInds(pop = as.vector(pop[, 1]), q = q)

#plot the correlation of residuals
pdf(file = "./data/genetic_data/quality_control/14_pop_strat/02_admixture/eval_admix/evaladmix_plot.pdf") # nolint
plotCorRes(cor_mat = r, pop = as.vector(pop[,1]), ord=ord, title="Evaluation of Admixture proportions assuming K=1", max_z=0.1, min_z=-0.1) # nolint
dev.off()
