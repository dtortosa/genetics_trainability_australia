
#######################################
#######################################
checking function to print nicely
#######################################
#######################################

###### checking function to print nicely ######

#######################################
#######################################
check behaviour run_bash
#######################################
#######################################

###### see working directory ######
/home/dftortosa/diego_docs/science/other_projects/australian_army_bishop/heavy_analyses/australian_army_bishop/quality_control


###### list files/folders there ######
02a_pre_imputation_qc.out
02bb_pre_imputation_qc_eval_admix_plot.Rout
02c_post_imputation_merging.out
02d_post_imputation_qc.out
data
literature
scripts
singularity_containers


#######################################
#######################################
APPLY QC
#######################################
#######################################

###### prepare folders ######


###### FIRST QC STEP ######

## filter ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./merged_1_geno.log.
Options in effect:
  --bfile ../00_plink_filesets/merged_file_sets/merged
  --geno 0.01
  --make-bed
  --out ./merged_1_geno

63997 MB RAM detected; reserving 31998 MB for main workspace.
28251318 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
0 variants removed due to missing genotype data (--geno).
28251318 variants and 1203 people pass filters and QC.
Note: No phenotypes present.
--make-bed to ./merged_1_geno.bed + ./merged_1_geno.bim + ./merged_1_geno.fam
... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.
./merged_1_geno.bed
./merged_1_geno.bim
./merged_1_geno.fam
./merged_1_geno.log


## check we have not lost any SNP due to missingness ##
FIRST QC FILTER WORKED FINE


###### SECOND QC STEP ######

## filter ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./02_second_qc_step/merged_2_geno.log.
Options in effect:
  --bfile ./01_first_qc_step/merged_1_geno
  --hwe 1e-6 midp
  --maf 0.05
  --make-bed
  --mind 0.01
  --out ./02_second_qc_step/merged_2_geno

63997 MB RAM detected; reserving 31998 MB for main workspace.
28251318 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
0 people removed due to missing genotype data (--mind).
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
--hwe: 155 variants removed due to Hardy-Weinberg exact test.
22748389 variants removed due to minor allele threshold(s)
(--maf/--max-maf/--mac/--max-mac).
5502774 variants and 1203 people pass filters and QC.
Note: No phenotypes present.
--make-bed to ./02_second_qc_step/merged_2_geno.bed +
./02_second_qc_step/merged_2_geno.bim + ./02_second_qc_step/merged_2_geno.fam
... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.
./02_second_qc_step/merged_2_geno.bed
./02_second_qc_step/merged_2_geno.bim
./02_second_qc_step/merged_2_geno.fam
./02_second_qc_step/merged_2_geno.log


## check we have the same number of samples and at least 5M SNPs ##
We had 28251318 SNPs before filtering and 5502774 after filtering, i.e., we have lost 22748544 
SECOND QC FILTER WORKED FINE


## check how many SNPs we retain due to setting the HWE threshold at 1-e6 instead of 0.05 and how many are under 1e-6 ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./merged_1_geno.log.
Options in effect:
  --bfile ./merged_1_geno
  --hardy
  --out ./merged_1_geno

63997 MB RAM detected; reserving 31998 MB for main workspace.
28251318 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
--hardy: Writing Hardy-Weinberg report (founders only) to ./merged_1_geno.hwe
... 0%0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.
We have 346249 SNPs with a HWE p-value between 1e-6 and 0.05
We have 151 SNPs with a HWE p-value under 1e-6
OK!


## check we do not lose too many SNPs for increasing MAF filter from 0.01 to 0.05 ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./merged_1_geno.log.
Options in effect:
  --bfile ./merged_1_geno
  --freq
  --out ./merged_1_geno

63997 MB RAM detected; reserving 31998 MB for main workspace.
28251318 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
--freq: Allele frequencies (founders only) written to ./merged_1_geno.frq .
We have 2225340 SNPs with a MAF between 0.01 and 0.05
OK! WE LOSE A REASONABLE AMOUNT OF SNPS DUE TO INCREASE MAF FROM 0.01 TO 0.05


###### THIRD QC STEP ######

## filter ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./03_third_qc_step/merged_3_geno.log.
Options in effect:
  --bfile ./02_second_qc_step/merged_2_geno
  --make-bed
  --mind 0.01
  --out ./03_third_qc_step/merged_3_geno

63997 MB RAM detected; reserving 31998 MB for main workspace.
5502774 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
0 people removed due to missing genotype data (--mind).
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
5502774 variants and 1203 people pass filters and QC.
Note: No phenotypes present.
--make-bed to ./03_third_qc_step/merged_3_geno.bed +
./03_third_qc_step/merged_3_geno.bim + ./03_third_qc_step/merged_3_geno.fam ...
0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.
./03_third_qc_step/merged_3_geno.bed
./03_third_qc_step/merged_3_geno.bim
./03_third_qc_step/merged_3_geno.fam
./03_third_qc_step/merged_3_geno.log


## check we do not lose any sample ##
THIRD QC FILTER WORKED FINE


## check that we do not have ANY snp with an RSQ equal or lower than 0.3 ##
Starting chromosome 1
Chromosome 1 is OK
Starting chromosome 2
Chromosome 2 is OK
Starting chromosome 3
Chromosome 3 is OK
Starting chromosome 4
Chromosome 4 is OK
Starting chromosome 5
Chromosome 5 is OK
Starting chromosome 6
Chromosome 6 is OK
Starting chromosome 7
Chromosome 7 is OK
Starting chromosome 8
Chromosome 8 is OK
Starting chromosome 9
Chromosome 9 is OK
Starting chromosome 10
Chromosome 10 is OK
Starting chromosome 11
Chromosome 11 is OK
Starting chromosome 12
Chromosome 12 is OK
Starting chromosome 13
Chromosome 13 is OK
Starting chromosome 14
Chromosome 14 is OK
Starting chromosome 15
Chromosome 15 is OK
Starting chromosome 16
Chromosome 16 is OK
Starting chromosome 17
Chromosome 17 is OK
Starting chromosome 18
Chromosome 18 is OK
Starting chromosome 19
Chromosome 19 is OK
Starting chromosome 20
Chromosome 20 is OK
Starting chromosome 21
Chromosome 21 is OK
Starting chromosome 22
Chromosome 22 is OK


## See the final number of samples and variants ##
We have 1203 samples and 5502774 SNPs after the third QC step


#######################################
#######################################
BATCH EFFECTS
#######################################
#######################################

###### check averages ######

## first MAF ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./merged_3_geno_batches.log.
Options in effect:
  --bfile ../03_third_qc_step/merged_3_geno
  --family
  --freq
  --out ./merged_3_geno_batches

63997 MB RAM detected; reserving 31998 MB for main workspace.
5502774 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
--family: 2 clusters defined.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
--freq: Cluster-stratified allele frequencies (founders only) written to
./merged_3_geno_batches.frq.strat .
 CHR                  SNP     CLST   A1   A2      MAF    MAC  NCHROBS
   1      chr1_758443_G_C combat_ILGSA24-17303    C    G   0.1136     35      308 
   1      chr1_758443_G_C combat_ILGSA24-17873    C    G  0.08294    174     2098 
   1      chr1_794299_C_G combat_ILGSA24-17303    C    G   0.1461     45      308 
   1      chr1_794299_C_G combat_ILGSA24-17873    C    G   0.1134    238     2098 
   1      chr1_796338_T_C combat_ILGSA24-17303    C    T   0.1136     35      308 
   1      chr1_796338_T_C combat_ILGSA24-17873    C    T  0.08723    183     2098 
   1      chr1_796652_A_C combat_ILGSA24-17303    C    A   0.1136     35      308 
   1      chr1_796652_A_C combat_ILGSA24-17873    C    A  0.08627    181     2098 
   1      chr1_798969_T_C combat_ILGSA24-17303    C    T   0.1136     35      308 
MAF-Avg1: 0.238977; MAF-Avg2:0.239235; MAF-Diff:-.000258


## then call rate ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./merged_3_geno_batches.log.
Options in effect:
  --bfile ../03_third_qc_step/merged_3_geno
  --family
  --missing
  --out ./merged_3_geno_batches

63997 MB RAM detected; reserving 31998 MB for main workspace.
5502774 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
--family: 2 clusters defined.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
--missing: Sample missing data report written to ./merged_3_geno_batches.imiss,
and variant-based cluster-stratified missing data report written to
./merged_3_geno_batches.lmiss.
 CHR                  SNP       CLST   N_MISS   N_CLST   N_GENO   F_MISS
   1      chr1_758443_G_C combat_ILGSA24-17303        0      154      154        0
   1      chr1_758443_G_C combat_ILGSA24-17873        0     1049     1049        0
   1      chr1_794299_C_G combat_ILGSA24-17303        0      154      154        0
   1      chr1_794299_C_G combat_ILGSA24-17873        0     1049     1049        0
   1      chr1_796338_T_C combat_ILGSA24-17303        0      154      154        0
   1      chr1_796338_T_C combat_ILGSA24-17873        0     1049     1049        0
   1      chr1_796652_A_C combat_ILGSA24-17303        0      154      154        0
   1      chr1_796652_A_C combat_ILGSA24-17873        0     1049     1049        0
   1      chr1_798969_T_C combat_ILGSA24-17303        0      154      154        0
MISSING-Avg1: 0; MISSING-Avg2:0; MISSING-Diff:0


###### check about the fact that we have NO missing genotypes after imputation ######
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./21_post_imputation_qc/04_batch_effects/missing_before_imputation.log.
Options in effect:
  --bfile ./19_topmed_prep/01_second_step/loop_maf_missing_2_pca_not_outliers_sex_full_clean_hwe_updated_chr_autosomals_miss_maf_snp_clean_sample_miss_clean-updated
  --missing
  --out ./21_post_imputation_qc/04_batch_effects/missing_before_imputation

63997 MB RAM detected; reserving 31998 MB for main workspace.
247731 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is 0.999601.
--missing: Sample missing data report written to
./21_post_imputation_qc/04_batch_effects/missing_before_imputation.imiss, and
variant-based missing data report written to
./21_post_imputation_qc/04_batch_effects/missing_before_imputation.lmiss.

MISSING RATE BEFORE IMPUTATION WAS: 0.00039891746854450993

###### check for association between the batch assignation and SNP frquencies ######

## calculate the association between snp frequencies and batches  ##
PLINK v1.90b7 64-bit (16 Jan 2023)             www.cog-genomics.org/plink/1.9/
(C) 2005-2023 Shaun Purcell, Christopher Chang   GNU General Public License v3
Logging to ./21_post_imputation_qc/04_batch_effects/merged_3_geno_batch_assoc.log.
Options in effect:
  --assoc
  --bfile ./21_post_imputation_qc/03_third_qc_step/merged_3_geno
  --out ./21_post_imputation_qc/04_batch_effects/merged_3_geno_batch_assoc
  --pheno ./21_post_imputation_qc/04_batch_effects/case_control.tsv

63997 MB RAM detected; reserving 31998 MB for main workspace.
5502774 variants loaded from .bim file.
1203 people (1035 males, 168 females) loaded from .fam.
1203 phenotype values present after --pheno.
Using 1 thread (no multithreaded calculations invoked).
Before main variant filters, 1203 founders and 0 nonfounders present.
Calculating allele frequencies... 0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99% done.
Total genotyping rate is exactly 1.
5502774 variants and 1203 people pass filters and QC.
Among remaining phenotypes, 1049 are cases and 154 are controls.
Writing C/C --assoc report to
./21_post_imputation_qc/04_batch_effects/merged_3_geno_batch_assoc.assoc ...
0%1%2%3%4%5%6%7%8%9%10%11%12%13%14%15%16%17%18%19%20%21%22%23%24%25%26%27%28%29%30%31%32%33%34%35%36%37%38%39%40%41%42%43%44%45%46%47%48%49%50%51%52%53%54%55%56%57%58%59%60%61%62%63%64%65%66%67%68%69%70%71%72%73%74%75%76%77%78%79%80%81%82%83%84%85%86%87%88%89%90%91%92%93%94%95%96%97%98%99%done.


## then calculate average p-value and number of signifncant SNPs  ##
The average p-value is 0.49726, while the number of SNPs with P<1e-4 is 754
OK! WE DO NOT HAVE SIGIFNICANT DIFFERENCES IN THE ALLELE FREQUENCIES OF THE SNPS BETWEEN BATCHES


#######################################
#######################################
FINISH
#######################################
#######################################
